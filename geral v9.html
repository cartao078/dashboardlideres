<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Integrado ‚Äî Sistema de Gest√£o</title>
<style>
  :root{
    --bg:#eef1f8;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#6b5dfc;
    --inativa-bg:#e5e7eb;
    --tab-active:#6b5dfc;
    --tab-inactive:#d1d5db;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
  }
  
  * { box-sizing: border-box; }
  
  body{
    margin:0; background:var(--bg); font-family:Arial,Helvetica,sans-serif; color:#1f2937;
    padding-top: 130px; 
  }
  
  .wrap{ max-width:1400px; margin:0 auto; padding:18px; padding-top: 0; }
  
  header{
    position: fixed; top: 0; left: 0; right: 0;
    display:flex; justify-content:space-between; align-items:center;
    background:var(--card); padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.06);
    flex-wrap:wrap; gap:10px; z-index: 1000;
  }
  
  .header-logo { height: 40px; width: auto; margin-bottom: 5px; }
  
  /* BOT√ïES MODERNIZADOS */
  .actions{ display:flex; gap:12px; flex-wrap:wrap; }
  .actions button{ 
    padding:10px 20px; border-radius:10px; border:0; cursor:pointer; 
    font-weight:700; font-size:14px; display: flex; align-items: center; gap: 8px;
    transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  }
  .actions button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
  .actions button:active { transform: translateY(0); }
  
  .reload{ background: #10b981; color: #fff; }
  .reload:hover { background: #059669; }
  
  .download-btn { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: white; 
  }
  .download-btn:hover { opacity: 0.9; }

  .tabs-container{
    background:var(--card); position: fixed; left: 0; right: 0; z-index: 999;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
  }
  
  .tabs-header{ display:flex; border-bottom:2px solid #e5e7eb; overflow-x:auto; background:#f9fafb; }
  
  .tab-button{
    flex:1; min-width:140px; padding:14px 16px; border:none; background:transparent;
    cursor:pointer; font-weight:600; font-size:14px; color:var(--muted);
    border-bottom:3px solid transparent; transition:all 0.3s; white-space:nowrap;
  }
  
  .tab-button.active{ color:var(--tab-active); border-bottom-color:var(--tab-active); }
  
  #tab-content-area { padding-top: 20px; }

  .tab-pane{
    display:none; padding:20px; background: var(--card);
    border-radius: 0 0 10px 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px;
  }
  
  .tab-pane.active{ display:block; }
  
  .top-cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin-bottom:20px; }
  .big-card{ padding:16px; border-radius:12px; color:#fff; background:linear-gradient(135deg,#6b5dfc,#b85cd9); transition:transform 0.2s; }
  .big-card.collab-metric { background: linear-gradient(135deg, #f59e0b, #d97706); }
  .big-card small{ opacity:0.9; font-size:12px; }
  .big-card h2{ margin:6px 0; font-size:28px; }
  .big-card div{ font-size:14px; opacity:0.95; }
  .section-title{ margin-top:26px; margin-bottom:12px; font-weight:800; color:#111827; font-size:18px; }
  .cards-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; margin-bottom:20px; }
  .card{ background:var(--card); border-radius:10px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,0.04); border:1px solid #e5e7eb; }
  .card h3{ text-align:center; margin:0 0 8px 0; font-size:14px; color:#111827; }
  .kv{ display:flex; justify-content:space-between; margin:6px 0; color:#374151; font-size:13px; }
  .progress-wrap{ margin-top:12px; }
  .progress{ background:#e6e9ee; border-radius:10px; height:20px; overflow:hidden; }
  .bar{ height:100%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; font-size:13px; min-width:30px; }
  .bar.green{background:#00ff00; color:#000}
  .bar.yellow{background:#ffff00; color:#000}
  .bar.red{background:#ff0000; color:#fff}
  .status-label{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; background:#fef3c7; color:#92400e; margin-left:6px; font-weight:600; }

  /* DASHBOARD COCKPIT */
  .cockpit-container { padding: 10px 0; }
  .cockpit-header { margin-bottom: 25px; }
  .cockpit-header h2 { font-size: 26px; font-weight: 800; margin: 0; color: #2B3674; }
  .cockpit-header p { color: #707EAE; margin: 5px 0 0 0; font-size: 14px; }
  .cockpit-grid-kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .cockpit-kpi-card { background: #F4F7FE; padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 12px; border: 1px solid #E9EDF7; }
  .cockpit-kpi-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; background: white; color: #4318FF; }
  .cockpit-kpi-info small { color: #A3AED0; font-size: 12px; font-weight: 600; display: block; }
  .cockpit-kpi-info h3 { margin: 0; font-size: 20px; font-weight: 800; color: #2B3674; }
  .cockpit-main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
  .cockpit-section { background: #F4F7FE; border-radius: 15px; padding: 20px; border: 1px solid #E9EDF7; }
  .cockpit-section h4 { margin: 0 0 15px 0; font-size: 16px; font-weight: 800; color: #2B3674; display: flex; align-items: center; gap: 8px; }
  .cockpit-metric { margin-bottom: 15px; }
  .cockpit-metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; font-weight: 700; }
  .cockpit-bar-bg { background: #E9EDF7; height: 6px; border-radius: 3px; overflow: hidden; }
  .cockpit-bar-fill { height: 100%; border-radius: 3px; transition: 0.5s; }

  /* CASHBACK CARDS */
  .cashback-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
  .cashback-card { background: var(--card); border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; }
  .cashback-card h3 { font-size: 13px; margin: 0 0 8px 0; text-align: center; }

  .month-selector-container {
    display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px;
    padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  .month-selector-container label { color: white; font-weight: 700; }
  .month-selector-container select { padding: 10px 16px; border-radius: 8px; border: 2px solid white; font-weight: 600; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <header>
    <div>
      <img src="img/logo.png" class="header-logo" alt="Logo">
      <div style="font-size:13px;color:var(--muted)">DASHBOARD LIDERES</div>
    </div>
    <div class="actions">
      <button class="reload" id="reload">üîÑ Recarregar Dados</button>
      <button class="download-btn" id="downloadBtn">üì• Baixar Imagem</button>
    </div>
  </header>

<div class="wrap">
  <div class="tabs-container">
    <div class="tabs-header">
      <button class="tab-button active" data-tab="dashboard">üìà Dashboard</button>
      <button class="tab-button" data-tab="contagemapp">üì± Contagem APP</button>
      <button class="tab-button" data-tab="vendas">üí∞ Vendas</button>
      <button class="tab-button" data-tab="retencao">üîê Reten√ß√£o</button>
      <button class="tab-button" data-tab="adimplencia">‚úÖ Adimpl√™ncia</button>
      <button class="tab-button" data-tab="cashback">üéÅ Cashback</button>
      <button class="tab-button" data-tab="refuturiza">üîÑ Refuturiza</button>
    </div>
  </div>
  
  <div id="tab-content-area">
      <div id="dashboard" class="tab-pane active">
        <div class="cockpit-container">
          <div class="cockpit-header">
            <h2>Cockpit de Lideran√ßa</h2>
            <p>Vis√£o estrat√©gica consolidada de todos os setores</p>
          </div>
          <div id="dashboardContent"></div>
        </div>
      </div>
      <div id="contagemapp" class="tab-pane"><div id="topCardsContagemApp" class="top-cards"></div><div id="sectionsContagemApp"></div></div>
      <div id="vendas" class="tab-pane"><div class="month-selector-container"><label for="monthSelector">üìÖ Selecionar M√™s:</label><select id="monthSelector"></select></div><div id="topCardsVendas" class="top-cards"></div><div id="sectionsVendas"></div></div>
      <div id="retencao" class="tab-pane"><div id="topCardsRetencao" class="top-cards"></div><div id="sectionsRetencao"></div></div>
      <div id="adimplencia" class="tab-pane"><div id="topCardsAdimplencia" class="top-cards"></div><div id="sectionsAdimplencia"></div></div>
      <div id="cashback" class="tab-pane"><div id="topCardsCashback" class="top-cards"></div><div id="sectionsCashback"></div></div>
      <div id="refuturiza" class="tab-pane"><div id="topCardsRefuturiza" class="top-cards"></div><div id="sectionsRefuturiza"></div></div>
  </div>
  <div class="footer">üí° Atualiza√ß√£o autom√°tica a cada 3 minutos</div>
</div>

<script>
const API_CONTAGEM_APP = "https://script.google.com/macros/s/AKfycby6ip-dZkmDIrG3GhutwY3t40DprmNlUxIf9kMBefFwzosOFri9nq2dSArTQVb1CUxF/exec";
const API_VENDAS = "https://script.google.com/macros/s/AKfycbyEUBjJlyuGt4cI8ySlSF32f0DY_qsaz_jnoqup9MPI_vKDGLBsIryOqKB_kXTMhTP6/exec";
const API_REFUTURIZA = "https://script.google.com/macros/s/AKfycbwjrD4H1nK8CTpSVT0n7T9BYonh-F5s7zx3E9QVeiJuO1vgFGMCqnWgYH0einPPjxYl/exec";
const API_RETENCAO = "https://script.google.com/macros/s/AKfycbzjQFDwj46u6Ymz33aT0SqVctD5Kvg4wkexeubg49rKl6OOXBoBdFnEASlFS5XRKhhZ/exec";
const API_ADIMPLENCIA = "https://script.google.com/macros/s/AKfycbzJ5TZAmTBpoZiT4Wss9RvdguIPaPHaJrakHvqz0qReCyC21oweNt84feMFMvmC118U/exec";
const API_CASHBACK = "https://script.google.com/macros/s/AKfycbxfI9vHstylYG7vjjf_5xDa_ElnBe9qcd6neiK4-bvoA6YrSK0MzY2Eq9jrAvOt2BnY/exec";

let lastDataContagemApp = null, lastDataVendas = null, lastDataRefuturiza = null, lastDataRetencao = null, lastDataAdimplencia = null, lastDataCashback = null;
let selectedMonth = null;

document.querySelectorAll('.tab-button').forEach(btn => {
  btn.addEventListener('click', function() {
    const tab = this.getAttribute('data-tab');
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
  });
});

function setupButtons() {
  // FUN√á√ÉO RECARREGAR CORRIGIDA
  document.getElementById('reload').onclick = () => {
    const btn = document.getElementById('reload');
    btn.innerHTML = '‚è≥ Carregando...';
    btn.disabled = true;
    init().then(() => {
      btn.innerHTML = '‚úÖ Atualizado!';
      setTimeout(() => {
        btn.innerHTML = 'üîÑ Recarregar Dados';
        btn.disabled = false;
      }, 2000);
    });
  };
  
  document.getElementById('downloadBtn').onclick = () => {
    const activePane = document.querySelector('.tab-pane.active');
    html2canvas(activePane, { backgroundColor: '#eef1f8', scale: 2, useCORS: true }).then(canvas => {
      const link = document.createElement('a'); link.href = canvas.toDataURL('image/png'); link.download = `Dashboard_${new Date().getTime()}.png`; link.click();
    });
  };
}

function safeNum(v) { if(v === null || v === undefined || v === '') return 0; const n = Number(v); return isNaN(n) ? 0 : n; }
function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(safeNum(v)); }
function pct(ok, total) { const t = safeNum(total); return t > 0 ? Math.round((safeNum(ok) / t) * 100) : 0; }
function colorClass(p) { if(p >= 89) return 'green'; if(p >= 85) return 'yellow'; return 'red'; }
function isInactive(p) { const s = String(p.status || '').toLowerCase(); return s === 'inativa' || s === 'ferias' || s === 'f√©rias' || s === 'ausente'; }

// RENDERIZADORES ORIGINAIS RESTAURADOS
function renderPersonCardContagem(p) {
  const total = safeNum(p.t), sem = safeNum(p.s), ok = safeNum(p.o), percent = pct(ok, total);
  const cls = isInactive(p) ? 'card inativa' : 'card';
  const statusTag = isInactive(p) ? `<span class="status-label">${p.status.toUpperCase()}</span>` : '';
  let bar = isInactive(p) ? '<div style="height:20px;background:#d1d5db;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px;font-weight:600">INATIVO</div>' : (total === 0 ? '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>' : `<div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div>`);
  return `<div class="${cls}"><h3>${p.nome || 'Sem nome'}${statusTag}</h3><div class="kv"><span>Total:</span><strong>${total}</strong></div><div class="kv"><span>Sem APP:</span><strong>${sem}</strong></div><div class="kv"><span>APP OK:</span><strong>${ok}</strong></div><div class="progress-wrap" style="margin-top:12px">${bar}</div></div>`;
}

function renderSection(title, arr, isVendasNovo = false) {
  if(!arr || arr.length === 0) return `<div class="section-title">${title} <span style="color:#9ca3af;font-size:14px;font-weight:400">(vazio)</span></div>`;
  const renderFunc = isVendasNovo ? renderPersonCardVendasNovo : renderPersonCardContagem;
  return `<div class="section-title">${title}</div><div class="cards-grid">${arr.map(renderFunc).join('')}</div>`;
}

function renderContagemApp() {
  const data = lastDataContagemApp?.data; if(!data) return;
  const ferias = ['MADALENA', 'INGRID', 'KAMYLA'];
  ['vendasInternas', 'conciliacao', 'refiliacao'].forEach(k => { if(data[k]) data[k].forEach(p => { if(ferias.includes(p.nome?.toUpperCase())) p.status = 'f√©rias'; }); });
  const gv = data.geral?.vendas || {total: 0, sem: 0, ok: 0}, gr = data.geral?.ref || {total: 0, sem: 0, ok: 0}, gtv = data.geral?.totalVendas || {total: 0, sem: 0, ok: 0}, gmc = data.geral?.metaCleonice || {total: 0, sem: 0, ok: 0};
  const renderBig = (t, v, s, o) => { const p = pct(o, v); return `<div class="big-card"><small>${t}</small><h2>${safeNum(v)}</h2><div>${safeNum(s)} Sem APP | ${safeNum(o)} APP OK</div><div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(p)}" style="width:${Math.max(p, 5)}%">${p}%</div></div></div></div>`; };
  document.getElementById('topCardsContagemApp').innerHTML = renderBig('VENDAS', gv.total, gv.sem, gv.ok) + renderBig('REFILIA√á√ÉO', gr.total, gr.sem, gr.ok) + renderBig('TOTAL VENDAS', gtv.total, gtv.sem, gtv.ok) + renderBig('META CLEONICE', gmc.total, gmc.sem, gmc.ok);
  document.getElementById('sectionsContagemApp').innerHTML = renderSection('VENDAS INTERNAS', data.vendasInternas) + renderSection('RECEP√á√ÉO', data.recepcao) + renderSection('REFILIA√á√ÉO', data.refiliacao) + renderSection('WEB/TELEVENDAS/OUTROS', data.webTelevendasOutros) + renderSection('CONCILIA√á√ÉO', data.conciliacao);
}

function renderPersonCardVendasNovo(p) {
  const vendas = safeNum(p.vendas), aprovados = safeNum(p.aprovados), qualidade = vendas > 0 ? Math.round((aprovados / vendas) * 100) : 0;
  const cls = isInactive(p) ? 'card inativa' : 'card';
  const statusTag = isInactive(p) ? `<span class="status-label">${p.status.toUpperCase()}</span>` : '';
  let bar = isInactive(p) ? '<div style="height:20px;background:#d1d5db;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px;font-weight:600">' + p.status.toUpperCase() + '</div>' : (vendas === 0 ? '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>' : `<div class="progress"><div class="bar ${colorClass(qualidade)}" style="width:${Math.max(qualidade, 5)}%">${qualidade}%</div></div>`);
  return `<div class="${cls}"><h3>${p.nome || 'Sem nome'}${statusTag}</h3><div class="kv"><span>Setor:</span><strong>${p.setor || '-'}</strong></div><div class="kv"><span>Vendas:</span><strong>${vendas}</strong></div><div class="kv"><span>Aprovados:</span><strong>${aprovados}</strong></div><div class="kv"><span>Qualidade:</span><strong>${qualidade}%</strong></div><div class="progress-wrap" style="margin-top:8px">${bar}</div></div>`;
}

function renderVendas() {
  if(!lastDataVendas) return;
  const g = lastDataVendas.geral || {vendas: 0, aprovados: 0, pendentes: 0, cancelados: 0}, q = g.vendas > 0 ? Math.round((g.aprovados / g.vendas) * 100) : 0;
  const renderBig = (t, v, s) => `<div class="big-card"><small>${t}</small><h2>${safeNum(v)}</h2><div>${s}</div></div>`;
  document.getElementById('topCardsVendas').innerHTML = renderBig('TOTAL VENDAS', g.vendas, `M√™s: ${lastDataVendas.mes || ''}`) + renderBig('APROVADOS', g.aprovados, `Qualidade: ${q}%`) + renderBig('PENDENTES', g.pendentes, 'Aguardando') + renderBig('CANCELADOS', g.cancelados, 'Canceladas');
  const sets = {}; (lastDataVendas.cards || []).forEach(c => { const s = c.setor || 'OUTROS'; if(!sets[s]) sets[s] = []; sets[s].push(c); });
  let h = ''; Object.keys(sets).sort().forEach(s => h += renderSection(s, sets[s], true));
  document.getElementById('sectionsVendas').innerHTML = h;
}

function renderRefuturiza() {
  const data = lastDataRefuturiza?.data; if(!data) return;
  const geral = data.geral || {totalRefuturiza: 0, comLigacao: 0, semLigacao: 0, porcentagem: 0, totalCancelados: 0}, consultores = data.consultores || [];
  const renderBig = (t, v, c, s) => { const p = pct(c, v); return `<div class="big-card"><small>${t}</small><h2>${safeNum(v)}</h2><div>${safeNum(c)} Com Liga√ß√£o | ${safeNum(s)} Sem Liga√ß√£o</div><div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(p)}" style="width:${Math.max(p, 5)}%">${p}%</div></div></div></div>`; };
  function renderConsultorCard(c) {
    const total = safeNum(c.total), comLig = safeNum(c.comLigacao), semLig = safeNum(c.semLigacao), cancel = safeNum(c.cancelados), p = safeNum(c.porcentagem);
    let bar = total === 0 ? '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>' : `<div class="progress"><div class="bar ${colorClass(p)}" style="width:${Math.max(p, 5)}%">${p}%</div></div>`;
    return `<div class="card"><h3>${c.nome || 'Sem nome'}</h3><div class="kv"><span>Total:</span><strong>${total}</strong></div><div class="kv"><span>Com Liga√ß√£o:</span><strong>${comLig}</strong></div><div class="kv"><span>Sem Liga√ß√£o:</span><strong>${semLig}</strong></div><div class="kv"><span>Cancelados:</span><strong>${cancel}</strong></div><div class="progress-wrap" style="margin-top:8px">${bar}</div></div>`;
  }
  document.getElementById('topCardsRefuturiza').innerHTML = renderBig('TOTAL REFUTURIZA', geral.totalRefuturiza, geral.comLigacao, geral.semLigacao) + `<div class="big-card"><small>TOTAL CANCELADOS</small><h2>${safeNum(geral.totalCancelados)}</h2></div>`;
  document.getElementById('sectionsRefuturiza').innerHTML = `<div class="section-title">CONSULTORES</div><div class="cards-grid">${consultores.map(renderConsultorCard).join('')}</div>`;
}

function renderRetencao() {
  if(!lastDataRetencao?.data) return;
  const data = lastDataRetencao.data, geral = data.geral || {}, consultoras = data.consultoras || [];
  const renderBig = (t, v, s) => `<div class="big-card"><small>${t}</small><h2>${v}</h2><div>${s}</div></div>`;
  function renderConsultoraRetencaoCard(nome) {
    const c = consultoras.find(x => x.nome?.toUpperCase() === nome.toUpperCase()); if(!c) return '';
    const ok = safeNum(c.retidosOkMes), cancel = safeNum(c.cancelamentosConta), tot = ok + cancel, p = tot > 0 ? Math.round((ok / tot) * 100) : 0;
    let bar = tot === 0 ? '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>' : `<div class="progress"><div class="bar ${colorClass(p)}" style="width:${Math.max(p, 5)}%">${p}%</div></div>`;
    return `<div class="card"><h3>${c.nome || 'Sem nome'}</h3><div class="kv"><span>Retidos OK:</span><strong>${ok}</strong></div><div class="kv"><span>Cancelados:</span><strong>${cancel}</strong></div><div class="progress-wrap" style="margin-top:12px">${bar}</div></div>`;
  }
  function renderConsultoraCard(c) {
    const totMes = safeNum(c.totalMes), retMes = safeNum(c.retidosMes), retOkMes = safeNum(c.retidosOkMes), retOkCalc = totMes - (retMes - retOkMes), qual = safeNum(c.qualidade), tot3 = safeNum(c.totalUltimos3Meses), ret3 = safeNum(c.mensOkUltimos3Meses) + safeNum(c.emAtrasoUltimos3Meses), can3 = safeNum(c.canceladoUltimos3Meses);
    let bar = totMes === 0 ? '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>' : `<div class="progress"><div class="bar ${colorClass(qual)}" style="width:${Math.max(qual, 5)}%">${qual}%</div></div>`;
    const ok3 = tot3 - (safeNum(c.emAtrasoUltimos3Meses) + can3), qual3 = tot3 > 0 ? Math.round((ok3 / tot3) * 100) : 0;
    const bar3 = tot3 === 0 ? '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>' : `<div class="progress"><div class="bar ${colorClass(qual3)}" style="width:${Math.max(qual3, 5)}%">${qual3}%</div></div>`;
    const u3 = `<div style="font-size:12px;color:#6b7280;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #e5e7eb"><strong>Ultimos 3 Meses</strong></div><div class="kv"><span>Total:</span><strong>${tot3}</strong></div><div class="kv"><span>Retidos:</span><strong>${ret3}</strong></div><div class="kv"><span>Cancelados:</span><strong>${can3}</strong></div><div class="kv"><span>Qualidade:</span><strong>${qual3}%</strong></div><div class="progress-wrap" style="margin-top:6px">${bar3}</div>`;
    const ma = `<div style="font-size:12px;color:#6b7280;margin:10px 0 8px 0;padding-top:8px;border-top:1px solid #e5e7eb"><strong>Mes Atual</strong></div><div class="kv"><span>Total Mes:</span><strong>${totMes}</strong></div><div class="kv"><span>Retidos OK:</span><strong>${retOkCalc}</strong></div><div class="kv"><span>Cancelados:</span><strong>${safeNum(c.canceladoMes)}</strong></div><div class="kv"><span>Qualidade:</span><strong>${qual}%</strong></div>`;
    return `<div class="card"><h3>${c.nome || 'Sem nome'}</h3>${u3}${ma}<div class="progress-wrap" style="margin-top:8px">${bar}</div></div>`;
  }
  const tr = safeNum(data.geral.totalRetidosMes), tc = safeNum(data.geral.totalCanceladosMes), tx = (tr + tc) > 0 ? ((tr / (tr + tc)) * 100).toFixed(2) : 0;
  let h = renderBig('TAXA DE RETENCAO', tx + '%', 'Retidos / (Retidos + Cancelados)') + renderBig('CHURN FRANQUIA', safeNum(data.geral.churnFranquia).toFixed(2) + '%', 'Cancelados dos consultores') + renderBig('CHURN RATE', safeNum(data.geral.churnRate).toFixed(2) + '%', 'Total de cancelados') + renderBig('TOTAL CANCELADOS MES', safeNum(data.geral.totalCanceladosMes), 'Cancelamentos do mes') + renderBig('TOTAL RETIDOS MES', safeNum(data.geral.totalRetidosMes), 'Clientes retidos');
  const k = renderConsultoraRetencaoCard('Kamyla'), j = renderConsultoraRetencaoCard('Jhane');
  if(k || j) h += '<div style="grid-column: 1 / -1; margin-top: 20px; margin-bottom: 12px; font-weight: 800; color: #111827; font-size: 18px;">RETENCAO POR CONSULTORA</div><div style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">' + k + j + '</div>';
  document.getElementById('topCardsRetencao').innerHTML = h;
  const cma = consultoras.filter(x => x.tipo === 'retencao'), sma = consultoras.filter(x => x.tipo === 'refiliacao');
  document.getElementById('sectionsRetencao').innerHTML = `<div class="section-title">CONSULTORAS - √öLTIMOS 3 MESES + M√äS ATUAL</div><div class="cards-grid">${cma.map(renderConsultoraCard).join('')}</div><div class="section-title" style="margin-top:30px">CONSULTORAS - √öLTIMOS 3 MESES (Recorr√™ncia)</div><div class="cards-grid">${sma.map(renderConsultoraCard).join('')}</div>`;
}

function renderAdimplencia() {
  const data = lastDataAdimplencia?.data; if(!data) return;
  const g = data.geral || {}, s = data.secoes || {};
  const renderBig = (t, v, sub) => `<div class="big-card"><small>${t}</small><h2>${v}</h2><div>${sub}</div></div>`;
  const renderF = (t, v, p) => `<div class="big-card"><small>${t}</small><h2>${v}</h2><div>${p}% do total</div><div class="progress"><div class="bar green" style="width:${Math.max(p, 5)}%">${p}%</div></div></div>`;
  const renderC = (c) => `<div class="card"><h3>${c.nome}</h3><div class="kv"><span>Arrecadado:</span><strong>${formatCurrency(c.arrecadado)}</strong></div><div class="kv"><span>QIA:</span><strong>${safeNum(c.qia)}</strong></div><div class="kv"><span>TK:</span><strong>${formatCurrency(c.tk)}</strong></div><div class="kv"><span>Trocas:</span><strong>${safeNum(c.totalTrocas)}</strong></div></div>`;
  document.getElementById('topCardsAdimplencia').innerHTML = renderBig('TOTAL MC', safeNum(g.totalMC), 'Total de movimenta√ß√µes') + renderBig('TOTAL ARRECADADO', formatCurrency(g.totalArrecadado), 'Valor total arrecadado') + renderBig('TKM', formatCurrency(g.tkm), 'Ticket m√©dio') + renderBig('TOTAL TROCAS', safeNum(g.totalTrocas), 'Trocas realizadas') + renderF('NOVOS REJEITADOS (NR)', safeNum(g.totalNIR), safeNum(g.percentNIR)) + renderF('1 a 3 meses', safeNum(g.total1a3), safeNum(g.percent1a3)) + renderF('4 a 6 meses', safeNum(g.total4a6), safeNum(g.percent4a6));
  document.getElementById('sectionsAdimplencia').innerHTML = `<div class="section-title">NOVOS REJEITADOS (NR)</div><div class="cards-grid">${s.nir.map(renderC).join('')}</div><div class="section-title">1 A 3 MESES EM ABERTO</div><div class="cards-grid">${s.um_a_tres.map(renderC).join('')}</div><div class="section-title">4 A 6 MESES EM ABERTO</div><div class="cards-grid">${s.quatro_a_seis.map(renderC).join('')}</div>`;
}

function renderCashback() {
  if(!lastDataCashback?.data) return;
  const data = lastDataCashback.data, geral = data.geral || {}, metricas = data.metricas || {}, parceiros = data.parceiros || [], colaboradores = data.colaboradores || [], colabMetricas = data.colaboradoresMetricas || {};
  function renderBigCard(title, value, subtitle, customClass = '', barHtml = '') {
    const cls = customClass ? `big-card ${customClass}` : 'big-card';
    return `<div class="${cls}"><small>${title}</small><h2>${value}</h2><div>${subtitle}</div>${barHtml}</div>`;
  }
  function getCorCashback(valor) { const v = safeNum(valor); if(v === 0) return '#ef4444'; if(v > 0 && v < 3) return '#eab308'; return '#22c55e'; }
  function renderParceiro(p) { if(p.nome === 'PARCEIROS') return ''; const valor = safeNum(p.valorCashback); return `<div class="cashback-card"><h3>${p.nome}</h3><div class="kv"><span>Segmento:</span><strong>${p.segmento || '-'}</strong></div><div class="kv"><span>Cashback:</span><strong>${formatCurrency(valor)}</strong></div><div class="kv"><span>Tend√™ncia:</span><strong>${formatCurrency(safeNum(p.tendencia))}</strong></div></div>`; }
  function renderColaborador(c) { const v = safeNum(c.cashbackMes), cor = getCorCashback(v), txt = (v > 0 && v < 3) ? '> R$0,00 e < R$3,00' : formatCurrency(v); return `<div class="cashback-card" style="border-left: 4px solid ${cor}"><h3>${c.nome}</h3><div class="kv"><span>Cashback:</span><strong style="color:${cor}">${txt}</strong></div><div class="kv"><span>Almo√ßo:</span><strong>${c.ganhouAlmoco ? '‚úì Ganhou' : '-'}</strong></div></div>`; }
  const topCards = document.getElementById('topCardsCashback');
  if(topCards) topCards.innerHTML = renderBigCard('TOTAL CASHBACK', formatCurrency(geral.totalCashback), 'Valor total gerado') + renderBigCard('USU√ÅRIOS √öNICOS', safeNum(metricas.realizadoUsuarios), 'Usu√°rios √∫nicos realizados');
  const sections = document.getElementById('sectionsCashback');
  if(sections) {
    const pv = parceiros.filter(p => p.nome !== 'PARCEIROS'), qp = pv.length, qp20 = pv.filter(p => safeNum(p.valorCashback) >= 20).length, p20 = qp > 0 ? ((qp20 / qp) * 100) : 0;
    const b20 = `<div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar green" style="width:${Math.max(p20, 5)}%">${p20.toFixed(2)}%</div></div></div>`;
    const totC = safeNum(colabMetricas.totalColaboradores), totA3 = safeNum(colabMetricas.totalAcima3), totZ = safeNum(colabMetricas.totalZerados), totE = Math.max(0, totC - totA3 - totZ), pE = totC > 0 ? ((totE / totC) * 100) : 0;
    const mu = safeNum(metricas.metaUsuariosUnicos), pu = mu > 0 ? ((safeNum(metricas.realizadoUsuarios) / mu) * 100) : 0, bu = `<div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(pu)}" style="width:${Math.max(pu, 5)}%">${pu.toFixed(2)}%</div></div></div>`;
    let html = '<div class="top-cards">' + renderBigCard('QTD. PARCEIROS', qp, 'Total de parceiros') + renderBigCard('QTD. >= R$ 20', qp20, 'Parceiros com valor >= R$ 20', '', b20) + renderBigCard('META DI√ÅRIA', formatCurrency(metricas.metaDiariaCashback), 'Meta di√°ria') + renderBigCard('TEND√äNCIA', formatCurrency(metricas.tendenciaRealizado), 'Tend√™ncia realizado') + renderBigCard('USU√ÅRIOS √öNICOS', safeNum(metricas.realizadoUsuarios), `Meta: ${mu} | ${pu.toFixed(2)}%`, '', bu) + renderBigCard('TOTAL COLAB.', totC, 'Total de colaboradores', 'collab-metric') + renderBigCard('ACIMA DE R$ 3', totA3, safeNum(colabMetricas.percentAcima3) + '%', 'collab-metric') + renderBigCard('ENTRE > R$0,00 e < R$3,00', totE, pE.toFixed(2) + '%', 'collab-metric') + renderBigCard('ZERADOS', totZ, safeNum(colabMetricas.percentZerados) + '%', 'collab-metric') + '</div>';
    if(pv.length > 0) html += `<div class="section-title">PARCEIROS</div><div class="cashback-grid">${pv.map(renderParceiro).join('')}</div>`;
    if(colaboradores.length > 0) html += `<div class="section-title">COLABORADORES</div><div class="cashback-grid">${colaboradores.map(renderColaborador).join('')}</div>`;
    sections.innerHTML = html;
  }
}

// DASHBOARD COCKPIT
function renderDashboard() {
  const content = document.getElementById('dashboardContent');
  const totalVendas = safeNum(lastDataVendas?.geral?.vendas);
  const totalArrecadado = formatCurrency(lastDataAdimplencia?.data?.geral?.totalArrecadado);
  const usuariosCashback = safeNum(lastDataCashback?.data?.metricas?.realizadoUsuarios);
  const retencaoGeral = lastDataRetencao?.data?.geral ? (safeNum(lastDataRetencao.data.geral.totalRetidosMes) / (safeNum(lastDataRetencao.data.geral.totalRetidosMes) + safeNum(lastDataRetencao.data.geral.totalCanceladosMes)) * 100).toFixed(1) : "0";
  content.innerHTML = `
    <div class="cockpit-grid-kpi">
      <div class="cockpit-kpi-card"><div class="cockpit-kpi-icon">üí∞</div><div class="cockpit-kpi-info"><small>Vendas M√™s</small><h3>${totalVendas}</h3></div></div>
      <div class="cockpit-kpi-card"><div class="cockpit-kpi-icon">üìà</div><div class="cockpit-kpi-info"><small>Arrecada√ß√£o</small><h3>${totalArrecadado}</h3></div></div>
      <div class="cockpit-kpi-card"><div class="cockpit-kpi-icon">üéÅ</div><div class="cockpit-kpi-info"><small>Usu√°rios Cashback</small><h3>${usuariosCashback}</h3></div></div>
      <div class="cockpit-kpi-card"><div class="cockpit-kpi-icon">üîê</div><div class="cockpit-kpi-info"><small>Taxa Reten√ß√£o</small><h3>${retencaoGeral}%</h3></div></div>
    </div>
    <div class="cockpit-main-grid">
      <div class="cockpit-section"><h4>üìä Desempenho de Vendas</h4>${renderCockpitMetric("Aprovados", lastDataVendas?.geral?.aprovados, "#05CD99", pct(lastDataVendas?.geral?.aprovados, lastDataVendas?.geral?.vendas))}${renderCockpitMetric("Pendentes", lastDataVendas?.geral?.pendentes, "#FFB547", pct(lastDataVendas?.geral?.pendentes, lastDataVendas?.geral?.vendas))}${renderCockpitMetric("Cancelados", lastDataVendas?.geral?.cancelados, "#EE5D50", pct(lastDataVendas?.geral?.cancelados, lastDataVendas?.geral?.vendas))}</div>
      <div class="cockpit-section"><h4>üîê Sa√∫de da Carteira (Reten√ß√£o)</h4>${renderCockpitMetric("Clientes Retidos", lastDataRetencao?.data?.geral?.totalRetidosMes, "#05CD99", 100)}${renderCockpitMetric("Cancelamentos", lastDataRetencao?.data?.geral?.totalCanceladosMes, "#EE5D50", 0)}${renderCockpitMetric("Churn Franquia", lastDataRetencao?.data?.geral?.churnFranquia + "%", "#8A3FFC", lastDataRetencao?.data?.geral?.churnFranquia)}</div>
      <div class="cockpit-section"><h4>üì± Engajamento APP</h4>${renderCockpitMetric("Vendas APP OK", lastDataContagemApp?.data?.geral?.vendas?.ok, "#39B8FF", pct(lastDataContagemApp?.data?.geral?.vendas?.ok, lastDataContagemApp?.data?.geral?.vendas?.total))}${renderCockpitMetric("Refilia√ß√£o APP OK", lastDataContagemApp?.data?.geral?.ref?.ok, "#8A3FFC", pct(lastDataContagemApp?.data?.geral?.ref?.ok, lastDataContagemApp?.data?.geral?.ref?.total))}</div>
      <div class="cockpit-section"><h4>‚úÖ Adimpl√™ncia</h4><div class="cockpit-metric-row"><span>Ticket M√©dio (TKM)</span><span>${formatCurrency(lastDataAdimplencia?.data?.geral?.tkm)}</span></div><div class="cockpit-metric-row"><span>Total Movimenta√ß√µes</span><span>${safeNum(lastDataAdimplencia?.data?.geral?.totalMC)}</span></div>${renderCockpitMetric("Novos Rejeitados (NIR)", lastDataAdimplencia?.data?.geral?.totalNIR, "#EE5D50", lastDataAdimplencia?.data?.geral?.percentNIR)}</div>
    </div>
  `;
}

function renderCockpitMetric(label, value, color, percent) {
  return `<div class="cockpit-metric"><div class="cockpit-metric-row"><span>${label}</span><span>${value}</span></div><div class="cockpit-bar-bg"><div class="cockpit-bar-fill" style="width:${percent}%; background:${color}"></div></div></div>`;
}

function populateMonthSelector() {
  const selector = document.getElementById('monthSelector'); if(!selector) return;
  const now = new Date(), months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
  for(let i = -12; i <= 3; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
    const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    const opt = document.createElement('option'); opt.value = val; opt.textContent = `${months[d.getMonth()]} de ${d.getFullYear()}`;
    if(i === 0) { opt.selected = true; selectedMonth = val; }
    selector.appendChild(opt);
  }
  selector.onchange = function() { selectedMonth = this.value; loadVendasData(); };
}

async function loadVendasData() {
  try { const res = await fetch(`${API_VENDAS}?mes=${selectedMonth}`); lastDataVendas = await res.json(); renderVendas(); renderDashboard(); } catch(e) { console.error(e); }
}

async function init() {
  try {
    const [c, v, r, rt, a, cb] = await Promise.all([
      fetch(API_CONTAGEM_APP).then(r => r.json()),
      fetch(selectedMonth ? `${API_VENDAS}?mes=${selectedMonth}` : API_VENDAS).then(r => r.json()),
      fetch(API_REFUTURIZA).then(r => r.json()),
      fetch(API_RETENCAO).then(r => r.json()),
      fetch(API_ADIMPLENCIA).then(r => r.json()),
      fetch(API_CASHBACK).then(r => r.json())
    ]);
    lastDataContagemApp = c; lastDataVendas = v; lastDataRefuturiza = r; lastDataRetencao = rt; lastDataAdimplencia = a; lastDataCashback = cb;
    renderContagemApp(); renderVendas(); renderRefuturiza(); renderRetencao(); renderAdimplencia(); renderCashback(); renderDashboard();
  } catch(e) { console.error(e); }
}

function adjustFixedElements() {
  const h = document.querySelector('header'), t = document.querySelector('.tabs-container'), b = document.querySelector('body');
  const hh = h.offsetHeight; t.style.top = `${hh}px`;
  const fh = hh + t.offsetHeight; b.style.paddingTop = `${fh + 18}px`;
}

document.addEventListener('DOMContentLoaded', () => {
  populateMonthSelector(); init(); setupButtons(); adjustFixedElements();
  window.addEventListener('resize', adjustFixedElements);
  setInterval(init, 180000);
});
</script>
</body>
</html>
