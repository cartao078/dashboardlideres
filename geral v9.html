<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Integrado ‚Äî Sistema de Gest√£o</title>
<style>
  :root{
    --bg:#eef1f8;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#6b5dfc;
    --inativa-bg:#e5e7eb;
    --tab-active:#6b5dfc;
    --tab-inactive:#d1d5db;
  }
  
  * {
    box-sizing: border-box;
  }
  
  body{
    margin:0;
    background:var(--bg);
    font-family:Arial,Helvetica,sans-serif;
    color:#1f2937;
    /* Este padding-top ser√° ajustado pelo JavaScript */
    padding-top: 130px; 
  }
  
  .wrap{
    max-width:1400px;
    margin:0 auto;
    padding:18px;
    padding-top: 0; /* O padding superior √© gerenciado pelo body */
  }
  
  header{
    position: fixed;
    top: 0; 
    left: 0;
    right: 0;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:var(--card);
    padding:14px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    flex-wrap:wrap;
    gap:10px;
    z-index: 1000;
    max-width: 100%;
    margin: 0;
    height: auto; /* Permite ajuste em mobile (quebra de linha) */
  }
  
  header h1{
    margin:0;
    color:var(--accent);
    font-size:24px;
  }
  
  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  
  .actions button{
    padding:8px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:700;
    font-size:13px;
  }
  
  .edit{background:var(--accent);color:#fff}
  .download{background:#8b5cf6;color:#fff}
  .copy{background:#e9e3ff;color:#5b3aa8}
  .reload{background:#10b981;color:#fff}
  .debug{background:#f59e0b;color:#fff}
  
  /* SISTEMA DE ABAS FIXO */
  /* Este container agora S√ì cont√©m o cabe√ßalho das abas (bot√µes) */
  .tabs-container{
    background:var(--card);
    border-radius:0;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
    overflow:visible;
    margin-bottom:0; 
    position: fixed;
    /* top ser√° ajustado pelo JS */
    left: 0;
    right: 0;
    z-index: 999;
  }
  
  .tabs-header{
    display:flex;
    border-bottom:2px solid #e5e7eb;
    overflow-x:auto;
    background:#f9fafb;
  }
  
  .tab-button{
    flex:1;
    min-width:140px;
    padding:14px 16px;
    border:none;
    background:transparent;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    color:var(--muted);
    border-bottom:3px solid transparent;
    transition:all 0.3s;
    white-space:nowrap;
  }
  
  .tab-button:hover{
    color:var(--accent);
    background:#f3f4f6;
  }
  
  .tab-button.active{
    color:var(--tab-active);
    border-bottom-color:var(--tab-active);
  }
  
  /* NOVO CONTAINER DE CONTE√öDO SCROLL√ÅVEL */
  #tab-content-area {
    padding-top: 20px; /* Espa√ßo para o visual da aba */
  }

  /* O tab-pane agora √© um container normal no fluxo do documento */
  .tab-pane{
    display:none;
    padding:20px; /* O padding que estava no .tabs-content */
    background: var(--card); /* Fundo branco para o conte√∫do */
    border-radius: 0 0 10px 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    margin-bottom: 20px;
  }
  
  .tab-pane.active{
    display:block;
  }
  
  /* CARDS E GRIDS */
  .top-cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:14px;
    margin-bottom:20px;
  }
  
  .big-card{
    padding:16px;
    border-radius:12px;
    color:#fff;
    background:linear-gradient(135deg,#6b5dfc,#b85cd9);
    transition:transform 0.2s;
  }
  
  .big-card:hover{
    transform:translateY(-2px);
  }
  
  .big-card small{
    opacity:0.9;
    font-size:12px;
  }
  
  .big-card h2{
    margin:6px 0;
    font-size:28px;
  }
  
  .big-card div{
    font-size:14px;
    opacity:0.95;
  }
  
  .section-title{
    margin-top:26px;
    margin-bottom:12px;
    font-weight:800;
    color:#111827;
    font-size:18px;
  }
  
  .cards-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
    gap:12px;
    margin-bottom:20px;
  }
  
  .card{
    background:var(--card);
    border-radius:10px;
    padding:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.04);
    transition:transform 0.2s;
    border:1px solid #e5e7eb;
  }
  
  .card:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(0,0,0,0.08);
  }
  
  .card.inativa{
    background:var(--inativa-bg);
    opacity:0.9;
  }
  
  .card h3{
    text-align:center;
    margin:0 0 8px 0;
    font-size:14px;
    color:#111827;
  }
  
  .kv{
    display:flex;
    justify-content:space-between;
    margin:6px 0;
    color:#374151;
    font-size:13px;
  }
  
  .progress-wrap{
    margin-top:12px;
  }
  
  .progress{
    background:#e6e9ee;
    border-radius:10px;
    height:20px;
    overflow:hidden;
  }
  
  .bar{
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:700;
    font-size:13px;
    transition:width 0.3s;
    min-width:30px;
  }
  
  .bar.yellow{color:#000}
  .bar.green{background:#00ff00}
  .bar.yellow{background:#ffff00}
  .bar.red{background:#ff0000}
  
  /* Novas cores para os cards do dashboard de colaboradores do Cashback */
  .big-card.total-colab { background: linear-gradient(135deg, #4299e1, #3182ce); } /* Azul */
  .big-card.acima-3 { background: linear-gradient(135deg, #48bb78, #38a169); } /* Verde */
  .big-card.entre-0-3 { background: linear-gradient(135deg, #f6ad55, #ed8936); } /* Laranja */
  .big-card.zerados { background: linear-gradient(135deg, #f56565, #e53e3e); } /* Vermelho */


  .status-label{
    display:inline-block;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    background:#fef3c7;
    color:#92400e;
    margin-left:6px;
    font-weight:600;
  }
  
  .debug-panel{
    background:#1f2937;
    color:#fff;
    padding:12px;
    border-radius:8px;
    margin-top:20px;
    font-family:monospace;
    font-size:12px;
    max-height:400px;
    overflow:auto;
    display:none;
  }
  
  .debug-panel.show{
    display:block;
  }
  
  .footer{
    margin-top:20px;
    color:var(--muted);
    font-size:13px;
    text-align:center;
  }
  
  @media(max-width:768px){
    .tabs-header{
      overflow-x:auto;
    }
    
    .tab-button{
      min-width:100px;
      padding:10px 12px;
      font-size:12px;
    }
    
    .top-cards{
      grid-template-columns:1fr;
    }
  }

  .download-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .download-btn:active {
    transform: translateY(0);
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    padding: 0 0 20px 0; /* Ajustado padding */
  }

  .dashboard-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid var(--accent);
  }

  .dashboard-section h3 {
    margin: 0 0 15px 0;
    color: var(--accent);
    font-size: 16px;
  }

  /* Cashback cards menores */
  .cashback-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
  }

  .cashback-card {
    background: var(--card);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    border: 1px solid #e5e7eb;
  }

  .cashback-card h3 {
    font-size: 13px;
    margin: 0 0 8px 0;
    text-align: center;
  }

  .cashback-card .kv {
    font-size: 12px;
    margin: 4px 0;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>üìä DASHBOARD INTEGRADO</h1>
      <div style="font-size:13px;color:var(--muted)">Sistema de Gest√£o Integrado</div>
    </div>
    <div class="actions">
      <button class="reload" id="reload">üîÑ Recarregar</button>
      <button class="debug" id="debugBtn">üêõ Debug</button>
      <button class="download-btn" id="downloadBtn">üì• Baixar Imagem</button>
    </div>
  </header>

<div class="wrap">
  <div class="tabs-container">
    <div class="tabs-header">
      <button class="tab-button active" data-tab="dashboard">üìà Dashboard</button>
      <button class="tab-button" data-tab="contagemapp">üì± Contagem APP</button>
      <button class="tab-button" data-tab="vendas">üí∞ Vendas</button>
      <button class="tab-button" data-tab="retencao">üîê Reten√ß√£o</button>
      <button class="tab-button" data-tab="adimplencia">‚úÖ Adimpl√™ncia</button>
      <button class="tab-button" data-tab="cashback">üéÅ Cashback</button>
      <button class="tab-button" data-tab="refuturiza">üîÑ Refuturiza</button>
    </div>
  </div>
  
  <div id="tab-content-area">
      <div id="dashboard" class="tab-pane active">
        <div style="margin-bottom:20px">
          <h2 style="color:var(--accent);margin:0 0 20px 0">Vis√£o Geral dos Indicadores</h2>
          <div id="dashboardContent"></div>
        </div>
      </div>
      
      <div id="contagemapp" class="tab-pane">
        <div id="topCardsContagemApp" class="top-cards"></div>
        <div id="sectionsContagemApp"></div>
      </div>
      
      <div id="vendas" class="tab-pane">
        <div id="topCardsVendas" class="top-cards"></div>
        <div id="sectionsVendas"></div>
      </div>
      
      <div id="retencao" class="tab-pane">
        <div id="topCardsRetencao" class="top-cards"></div>
        <div id="sectionsRetencao"></div>
      </div>
      
      <div id="adimplencia" class="tab-pane">
        <div id="topCardsAdimplencia" class="top-cards"></div>
        <div id="sectionsAdimplencia"></div>
      </div>
      
      <div id="cashback" class="tab-pane">
        <div id="topCardsCashback" class="top-cards"></div>
        <div id="sectionsCashback"></div>
      </div>
      
      <div id="refuturiza" class="tab-pane">
        <div id="topCardsRefuturiza" class="top-cards"></div>
        <div id="sectionsRefuturiza"></div>
      </div>
  </div>
  
  <div id="debugPanel" class="debug-panel"></div>
  <div class="footer">üí° Atualiza√ß√£o autom√°tica a cada 3 minutos</div>
</div>

<script>
// APIs INDEPENDENTES
const API_CONTAGEM_APP = "https://script.google.com/macros/s/AKfycby6ip-dZkmDIrG3GhutwY3t40DprmNlUxIf9kMBefFwzosOFri9nq2dSArTQVb1CUxF/exec";
const API_VENDAS = "https://script.google.com/macros/s/AKfycbz2iN8BFtjs0GHD1W84c0hNvRJIuJu3pmv-L0YcboGSgLhd2LQNOJMieJLTNWQC/exec";
const API_REFUTURIZA = "https://script.google.com/macros/s/AKfycbwjrD4H1nK8CTpSVT0n7T9BYonh-F5s7zx3E9QVeiJuO1vgFGMCqnWgYH0einPPjxYl/exec";
const API_RETENCAO = "https://script.google.com/macros/s/AKfycbyXDAGOZn9VUNMMlAE-RtQpIFr70TndFXp_WLC1bErHDkjQyKfdr-gWoYJZsRhjjA/exec";
const API_ADIMPLENCIA = "https://script.google.com/macros/s/AKfycbzJ5TZAmTBpoZiT4Wss9RvdguIPaPHaJrakHvqz0qReCyC21oweNt84feMFMvmC118U/exec";
const API_CASHBACK = "https://script.google.com/macros/s/AKfycbxfI9vHstylYG7vjjf_5xDa_ElnBe9qcd6neiK4-bvoA6YrSK0MzY2Eq9jrAvOt2BnY/exec";

// Vari√°veis para armazenar o √∫ltimo dado e o status de carregamento
let lastDataContagemApp = null;
let lastDataVendas = null;
let lastDataRefuturiza = null;
let lastDataRetencao = null;
let lastDataAdimplencia = null;
let lastDataCashback = null;
let debugMode = false;

const tabsLoaded = {
    contagemapp: false,
    vendas: false,
    retencao: false,
    adimplencia: false,
    cashback: false,
    refuturiza: false
};

// --- FUN√á√ïES DE UTILIDADE GERAL ---

/**
 * Formata um n√∫mero como valor monet√°rio brasileiro (R$ X.XXX,XX).
 * @param {number} v - O valor a ser formatado.
 * @returns {string} O valor formatado.
 */
function formatCurrency(v) {
  const n = safeNum(v);
  return 'R$ ' + n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function safeNum(v) {
  if(v === null || v === undefined || v === '') return 0;
  const n = Number(v);
  return isNaN(n) ? 0 : n;
}

function pct(ok, total) {
  const o = safeNum(ok);
  const t = safeNum(total);
  return t > 0 ? Math.round((o / t) * 100) : 0;
}

function colorClass(p) {
  if(p >= 89) return 'green';
  if(p >= 85) return 'yellow';
  return 'red';
}

function isInactive(p) {
  const s = String(p.status || '').toLowerCase();
  return s === 'inativa' || s === 'ferias' || s === 'f√©rias' || s === 'ausente';
}

// --- SISTEMA DE ABAS E CARREGAMENTO ---

document.querySelectorAll('.tab-button').forEach(btn => {
  btn.addEventListener('click', function() {
    const tab = this.getAttribute('data-tab');
    switchTab(tab);
    if (tab !== 'dashboard' && !tabsLoaded[tab]) {
        loadTabData(tab);
    }
  });
});

function switchTab(tab) {
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  
  document.querySelectorAll('.tab-pane').forEach(pane => {
    pane.classList.remove('active');
  });
  document.getElementById(tab).classList.add('active');
}

/**
 * Carrega os dados de uma aba espec√≠fica APENAS uma vez.
 * @param {string} tab - O nome da aba ('contagemapp', 'vendas', etc.).
 */
async function loadTabData(tab, forceReload = false) {
    // Se n√£o for para for√ßar, e j√° estiver carregado, saia.
    if (!forceReload && tabsLoaded[tab]) return;

    const apiMap = {
        contagemapp: API_CONTAGEM_APP,
        vendas: API_VENDAS,
        refuturiza: API_REFUTURIZA,
        retencao: API_RETENCAO,
        adimplencia: API_ADIMPLENCIA,
        cashback: API_CASHBACK
    };

    const renderMap = {
        contagemapp: renderContagemApp,
        vendas: renderVendas,
        refuturiza: renderRefuturiza,
        retencao: renderRetencao,
        adimplencia: renderAdimplencia,
        cashback: renderCashback
    };
    
    const dataVarMap = {
        contagemapp: 'lastDataContagemApp',
        vendas: 'lastDataVendas',
        refuturiza: 'lastDataRefuturiza',
        retencao: 'lastDataRetencao',
        adimplencia: 'lastDataAdimplencia',
        cashback: 'lastDataCashback'
    };

    const api = apiMap[tab];
    const render = renderMap[tab];
    const dataVar = dataVarMap[tab];
    
    const paneElement = document.getElementById(tab);
    if (!api || !paneElement) return;

    // Salva o HTML original da aba para restaurar se houver sucesso
    const originalContent = paneElement.innerHTML; 
    
    // Indicador de carregamento (Opcional, mas √∫til)
    if(forceReload || !tabsLoaded[tab]) {
        paneElement.innerHTML = `<div style="padding:20px;text-align:center;color:var(--accent);font-weight:600;">üîÑ Carregando dados da aba ${tab.toUpperCase()}...</div>`;
    }

    try {
        const res = await fetch(api + '?_=' + Date.now());
        if(res.ok) {
            window[dataVar] = await res.json();
            // Restaura o layout original (vazio) e chama o render
            if (tab !== 'dashboard') {
                // Para abas que n√£o s√£o o dashboard, precisamos re-criar os sub-elementos (cards/sections)
                paneElement.innerHTML = `
                    ${tab === 'dashboard' ? '' : `<div id="topCards${capitalize(tab)}" class="top-cards"></div>`}
                    ${tab === 'dashboard' ? '' : `<div id="sections${capitalize(tab)}"></div>`}
                    ${tab === 'dashboard' ? `<div style="margin-bottom:20px"><h2 style="color:var(--accent);margin:0 0 20px 0">Vis√£o Geral dos Indicadores</h2><div id="dashboardContent"></div></div>` : ''}
                `;
            } else {
                 // A aba dashboard j√° tem a estrutura interna renderDashboard que a populou antes.
                 // N√£o precisamos restaurar, pois renderDashboard sempre vai popular dashboardContent.
            }
            
            render();
            tabsLoaded[tab] = true;
        } else {
            console.error(`Erro ao carregar ${tab}: Resposta HTTP n√£o OK (${res.status})`);
            // Exibe mensagem de erro na aba
            paneElement.innerHTML = `
                <div style="padding:20px;text-align:center;color:red;border:1px solid red;border-radius:8px;">
                    ‚ùå **Erro ao carregar dados de ${tab.toUpperCase()}**: Resposta HTTP n√£o OK (${res.status}).<br>
                    Verifique a URL da API para esta aba no c√≥digo.
                </div>
            `;
            window[dataVar] = null; // Garante que a vari√°vel de dados est√° vazia
            tabsLoaded[tab] = false; // Permite retentar no clique
        }
    } catch(err) {
        console.error(`Erro ao carregar ${tab}:`, err);
         // Exibe mensagem de erro na aba
        paneElement.innerHTML = `
            <div style="padding:20px;text-align:center;color:red;border:1px solid red;border-radius:8px;">
                ‚ùå **Erro de rede na requisi√ß√£o de ${tab.toUpperCase()}**.<br>
                Verifique o console do navegador (F12) para detalhes sobre a falha do *fetch*.
            </div>
        `;
        window[dataVar] = null; // Garante que a vari√°vel de dados est√° vazia
        tabsLoaded[tab] = false; // Permite retentar no clique
    }
}

function capitalize(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
}

/**
 * Carrega todos os dados (usado para Dashboard e Recarregar tudo).
 */
async function init() {
  const loadPromises = [
    loadTabData('contagemapp', true), 
    loadTabData('vendas', true),
    loadTabData('refuturiza', true),
    loadTabData('retencao', true),
    loadTabData('adimplencia', true),
    loadTabData('cashback', true)
  ];
  
  await Promise.all(loadPromises);
  
  renderDashboard();
  
  // Re-renderiza a aba ativa ap√≥s o carregamento completo, se n√£o for o dashboard.
  const activeTab = document.querySelector('.tab-button.active').getAttribute('data-tab');
  if(activeTab !== 'dashboard') {
     const renderMap = {
        contagemapp: renderContagemApp, vendas: renderVendas, refuturiza: renderRefuturiza, 
        retencao: renderRetencao, adimplencia: renderAdimplencia, cashback: renderCashback
     };
     if(renderMap[activeTab]) renderMap[activeTab]();
  }
  
  showDebug(); // Mostra o status de carregamento no painel de debug.
}

// --- BOT√ïES DE A√á√ÉO E UTILIDADES ---

function setupButtons() {
  const reloadBtn = document.getElementById('reload');
  const debugBtn = document.getElementById('debugBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  
  if(reloadBtn) {
    reloadBtn.onclick = function(e) {
      e.preventDefault();
      console.log('Recarregando dados...');
      // Marca todas as abas como n√£o carregadas para for√ßar o recarregamento
      Object.keys(tabsLoaded).forEach(key => tabsLoaded[key] = false);
      init();
    };
  }
  
  if(debugBtn) {
    debugBtn.onclick = function(e) {
      e.preventDefault();
      debugMode = !debugMode;
      document.getElementById('debugPanel').classList.toggle('show');
      if(debugMode) {
        showDebug();
      }
    };
  }
  
  if(downloadBtn) {
    downloadBtn.onclick = function(e) {
      e.preventDefault();
      downloadTabAsImage();
    };
  }
}

// Executar quando o DOM estiver pronto
if(document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupButtons);
} else {
  setupButtons();
}

function downloadTabAsImage() {
  const activePane = document.querySelector('.tab-pane.active');
  const activeTabBtn = document.querySelector('.tab-button.active');
  
  if (!activePane || !activeTabBtn) {
    alert('Nenhuma aba ativa encontrada!');
    return;
  }

  const tabName = activeTabBtn.textContent.trim();
  const fileName = `${tabName}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.png`;

  // Capturamos o elemento da aba ativa
  html2canvas(activePane, {
    backgroundColor: '#eef1f8',
    scale: 2,
    logging: false,
    useCORS: true,
    allowTaint: true
  }).then(canvas => {
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = fileName;
    link.click();
  }).catch(err => {
    console.error('Erro ao capturar imagem:', err);
    alert('Erro ao baixar a imagem. Verifique o console para mais detalhes.');
  });
}

function showDebug() {
  const panel = document.getElementById('debugPanel');
  let html = '<strong>üìä DADOS RECEBIDOS (status **null** indica falha):</strong><br><br>';
  html += '<strong>CONTAGEM APP:</strong><br>' + JSON.stringify(lastDataContagemApp, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
  html += '<br><br><strong>VENDAS:</strong><br>' + JSON.stringify(lastDataVendas, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
  html += '<br><br><strong>REFUTURIZA:</strong><br>' + JSON.stringify(lastDataRefuturiza, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
  html += '<br><br><strong>RETENCAO:</strong><br>' + JSON.stringify(lastDataRetencao, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
  html += '<br><br><strong>ADIMPLENCIA:</strong><br>' + JSON.stringify(lastDataAdimplencia, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
  html += '<br><br><strong>CASHBACK:</strong><br>' + JSON.stringify(lastDataCashback, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;');
  panel.innerHTML = html;
}

// --- FUN√á√ïES DE RENDERIZA√á√ÉO DE CARDS PESSOAIS (SEM ALTERA√á√ÉO DE L√ìGICA) ---

function renderPersonCardContagem(p) {
  const total = safeNum(p.t);
  const sem = safeNum(p.s);
  const ok = safeNum(p.o);
  const percent = pct(ok, total);
  const cls = isInactive(p) ? 'card inativa' : 'card';
  const statusTag = isInactive(p) ? `<span class="status-label">${p.status.toUpperCase()}</span>` : '';
  
  let bar;
  if(isInactive(p)) {
    bar = '<div style="height:20px;background:#d1d5db;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px;font-weight:600">INATIVO</div>';
  } else if(total === 0) {
    bar = '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>';
  } else {
    bar = `<div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div>`;
  }
  
  return `<div class="${cls}"><h3>${p.nome || 'Sem nome'}${statusTag}</h3><div class="kv"><span>Total:</span><strong>${total}</strong></div><div class="kv"><span>Sem APP:</span><strong>${sem}</strong></div><div class="kv"><span>APP OK:</span><strong>${ok}</strong></div><div class="progress-wrap" style="margin-top:12px">${bar}</div></div>`;
}

function renderPersonCardVendas(p) {
  const total = safeNum(p.totalVendas);
  const qualidade = safeNum(p.qualidade);
  const cdtSonhos = safeNum(p.cdtSonhos);
  const pendenciaDocs = safeNum(p.pendenciaDocs);
  const pendenciaLig = safeNum(p.pendenciaLig);
  const cancelados = safeNum(p.cancelados);
  const cls = isInactive(p) ? 'card inativa' : 'card';
  const statusTag = isInactive(p) ? `<span class="status-label">${p.status.toUpperCase()}</span>` : '';
  
  let bar;
  if(isInactive(p)) {
    bar = '<div style="height:20px;background:#d1d5db;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px;font-weight:600">' + p.status.toUpperCase() + '</div>';
  } else if(total === 0) {
    bar = '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>';
  } else {
    bar = `<div class="progress"><div class="bar ${colorClass(qualidade)}" style="width:${Math.max(qualidade, 5)}%">${qualidade}%</div></div>`;
  }
  
  return `<div class="${cls}"><h3>${p.nome || 'Sem nome'}${statusTag}</h3><div class="kv"><span>Total Vendas:</span><strong>${total}</strong></div><div class="kv"><span>CDT Sonhos:</span><strong>${cdtSonhos}</strong></div><div class="kv"><span>Pend. Docs:</span><strong>${pendenciaDocs}</strong></div><div class="kv"><span>Pend. Lig:</span><strong>${pendenciaLig}</strong></div><div class="kv"><span>Cancelados:</span><strong>${cancelados}</strong></div><div class="kv"><span>Qualidade:</span><strong>${qualidade}%</strong></div><div class="progress-wrap" style="margin-top:8px">${bar}</div></div>`;
}

function renderSection(title, arr, isVendas = false) {
  if(!arr || !Array.isArray(arr) || arr.length === 0) return `<div class="section-title">${title} <span style="color:#9ca3af;font-size:14px;font-weight:400">(vazio)</span></div>`;
  const renderFunc = isVendas ? renderPersonCardVendas : renderPersonCardContagem;
  return `<div class="section-title">${title}</div><div class="cards-grid">${arr.map(renderFunc).join('')}</div>`;
}

// --- FUN√á√ïES DE RENDERIZA√á√ÉO DE ABAS (COM ALTERA√á√ïES) ---

function renderContagemApp() {
  const data = lastDataContagemApp?.data;
  if(!data) return;
  
  const ferias = ['MADALENA', 'INGRID', 'KAMYLA'];
  if(data.vendasInternas) {
    data.vendasInternas.forEach(p => {
      if(ferias.includes(p.nome?.toUpperCase())) p.status = 'f√©rias';
    });
  }
  if(data.conciliacao) {
    data.conciliacao.forEach(p => {
      if(ferias.includes(p.nome?.toUpperCase())) p.status = 'f√©rias';
    });
  }
  if(data.refiliacao) {
    data.refiliacao.forEach(p => {
      if(ferias.includes(p.nome?.toUpperCase())) p.status = 'f√©rias';
    });
  }
  
  const gv = data.geral?.vendas || {total: 0, sem: 0, ok: 0};
  const gr = data.geral?.ref || {total: 0, sem: 0, ok: 0};
  const gtv = data.geral?.totalVendas || {total: 0, sem: 0, ok: 0};
  const gmc = data.geral?.metaCleonice || {total: 0, sem: 0, ok: 0};
  
  function renderBigCardWithBar(title, total, sem, ok) {
    const percent = pct(ok, total);
    const bar = total === 0 ? '' : `<div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div></div>`;
    return `<div class="big-card"><small>${title}</small><h2>${safeNum(total)}</h2><div>${safeNum(sem)} Sem APP | ${safeNum(ok)} APP OK</div>${bar}</div>`;
  }
  
  const topCards = document.getElementById('topCardsContagemApp');
  topCards.innerHTML = 
    renderBigCardWithBar('VENDAS', gv.total, gv.sem, gv.ok) +
    renderBigCardWithBar('REFILIA√á√ÉO', gr.total, gr.sem, gr.ok) +
    renderBigCardWithBar('TOTAL VENDAS', gtv.total, gtv.sem, gtv.ok) +
    renderBigCardWithBar('META CLEONICE', gmc.total, gmc.sem, gmc.ok);
  
  const sections = document.getElementById('sectionsContagemApp');
  sections.innerHTML = 
    renderSection('VENDAS INTERNAS', data.vendasInternas) +
    renderSection('RECEP√á√ÉO', data.recepcao) +
    renderSection('REFILIA√á√ÉO', data.refiliacao) +
    renderSection('WEB/TELEVENDAS/OUTROS', data.webTelevendasOutros) +
    renderSection('CONCILIA√á√ÉO', data.conciliacao);
}

function renderVendas() {
  const data = lastDataVendas?.data;
  if(!data) return;
  
  if(data.refiliacao) {
    data.refiliacao.forEach(p => {
      if(p.nome?.toUpperCase() === 'INGRID') p.status = 'f√©rias';
    });
  }
  
  const geral = data.geral || {};
  
  function renderBigCardVendas(title, total, pendencia, ok) {
    const percent = pct(ok, total);
    const bar = total === 0 ? '' : `<div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div></div>`;
    return `<div class="big-card"><small>${title}</small><h2>${safeNum(total)}</h2><div>${safeNum(pendencia)} Pend√™ncias | ${safeNum(ok)} OK</div>${bar}</div>`;
  }
  
  const totalCanceladosGeral = safeNum(geral.totalCancelados?.recepcao) + safeNum(geral.totalCancelados?.filiacao) + safeNum(geral.totalCancelados?.refiliacao) + safeNum(geral.totalCancelados?.webTelevendas) + safeNum(geral.totalCancelados?.outros);
  
  const topCards = document.getElementById('topCardsVendas');
  topCards.innerHTML = 
    renderBigCardVendas('FILIADOS CTC LIG/DOC', geral.filiadosCTCLigDoc?.total, geral.filiadosCTCLigDoc?.pendencia, geral.filiadosCTCLigDoc?.ok) +
    renderBigCardVendas('WEB/TELEVENDAS LIG', geral.webTelevendasLig?.total, geral.webTelevendasLig?.pendencia, geral.webTelevendasLig?.ok) +
    renderBigCardVendas('VENDAS TOTAIS', geral.vendasTotais?.total, geral.vendasTotais?.pendencia, geral.vendasTotais?.ok) +
    `<div class="big-card"><small>TOTAL CANCELADOS</small><h2>${totalCanceladosGeral}</h2></div>`;
  
  const sections = document.getElementById('sectionsVendas');
  sections.innerHTML = 
    renderSection('RECEP√á√ÉO', data.recepcao, true) +
    renderSection('VENDAS', data.vendas, true) +
    renderSection('REFILIA√á√ÉO', data.refiliacao, true) +
    renderOutrosSection('OUTROS', data.outros) +
    renderOutrosSection('WEB', data.web) +
    renderOutrosSection('TELEVENDAS', data.televendas);
}

function renderOutrosSection(title, dados) {
  if(!dados) return '';
  const ok = safeNum(dados.total) - safeNum(dados.pendenciaDocs) - safeNum(dados.pendenciaLig);
  const percent = pct(ok, dados.total);
  const bar = dados.total === 0 ? '' : `<div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div></div>`;
  const html = `<div class="section-title">${title}</div><div class="cards-grid"><div class="card"><h3>${title}</h3><div class="kv"><span>Total:</span><strong>${safeNum(dados.total)}</strong></div><div class="kv"><span>CDT Sonhos:</span><strong>${safeNum(dados.cdtSonhos)}</strong></div><div class="kv"><span>Pend. Docs:</span><strong>${safeNum(dados.pendenciaDocs)}</strong></div><div class="kv"><span>Pend. Lig:</span><strong>${safeNum(dados.pendenciaLig)}</strong></div><div class="kv"><span>Cancelados:</span><strong>${safeNum(dados.cancelados)}</strong></div>${bar}</div></div>`;
  return html;
}

function renderRefuturiza() {
  const data = lastDataRefuturiza?.data;
  if(!data) return;
  
  const geral = data.geral || {totalRefuturiza: 0, comLigacao: 0, semLigacao: 0, porcentagem: 0, totalCancelados: 0};
  const consultores = data.consultores || [];
  
  function renderBigCardRefuturiza(title, total, comLigacao, semLigacao) {
    const percent = pct(comLigacao, total);
    const bar = total === 0 ? '' : `<div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div></div>`;
    return `<div class="big-card"><small>${title}</small><h2>${safeNum(total)}</h2><div>${safeNum(comLigacao)} Com Liga√ß√£o | ${safeNum(semLigacao)} Sem Liga√ß√£o</div>${bar}</div>`;
  }
  
  function renderConsultorCard(c) {
    const total = safeNum(c.total);
    const comLigacao = safeNum(c.comLigacao);
    const semLigacao = safeNum(c.semLigacao);
    const cancelados = safeNum(c.cancelados);
    const percent = safeNum(c.porcentagem);
    
    let bar;
    if(total === 0) {
      bar = '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>';
    } else {
      bar = `<div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div>`;
    }
    
    return `<div class="card"><h3>${c.nome || 'Sem nome'}</h3><div class="kv"><span>Total:</span><strong>${total}</strong></div><div class="kv"><span>Com Liga√ß√£o:</span><strong>${comLigacao}</strong></div><div class="kv"><span>Sem Liga√ß√£o:</span><strong>${semLigacao}</strong></div><div class="kv"><span>Cancelados:</span><strong>${cancelados}</strong></div><div class="progress-wrap" style="margin-top:8px">${bar}</div></div>`;
  }
  
  const topCards = document.getElementById('topCardsRefuturiza');
  if(topCards) {
    topCards.innerHTML = 
      renderBigCardRefuturiza('TOTAL REFUTURIZA', geral.totalRefuturiza, geral.comLigacao, geral.semLigacao) +
      `<div class="big-card"><small>TOTAL CANCELADOS</small><h2>${safeNum(geral.totalCancelados)}</h2></div>`;
  }
  
  const sections = document.getElementById('sectionsRefuturiza');
  if(sections) {
    if(consultores.length === 0) {
      sections.innerHTML = '<div class="section-title">CONSULTORES <span style="color:#9ca3af;font-size:14px;font-weight:400">(vazio)</span></div>';
    } else {
      sections.innerHTML = `<div class="section-title">CONSULTORES</div><div class="cards-grid">${consultores.map(renderConsultorCard).join('')}</div>`;
    }
  }
}

function renderRetencao() {
  if(!lastDataRetencao?.data) return;
  
  const data = lastDataRetencao.data;
  const geral = data.geral || {};
  const consultoras = data.consultoras || [];
  
  function renderBigCardRetencao(title, value, subtitle) {
    return `<div class="big-card"><small>${title}</small><h2>${value}</h2><div>${subtitle}</div></div>`;
  }
  
  function renderConsultoraCard(c) {
    const totalMes = safeNum(c.totalMes);
    const retidosMes = safeNum(c.retidosMes);
    const qualidade = safeNum(c.qualidade);
    const totalUltimos3 = safeNum(c.totalUltimos3Meses);
    // Corre√ß√£o: Retidos nos √∫ltimos 3 meses √© o total menos os cancelados
    const retidosUltimos3 = totalUltimos3 - safeNum(c.canceladoUltimos3Meses); 
    const canceladosUltimos3 = safeNum(c.canceladoUltimos3Meses);
    
    // Calcula a qualidade dos √∫ltimos 3 meses: (Total - Cancelados) / Total
    const qualidadeUltimos3 = totalUltimos3 > 0 ? Math.round(((totalUltimos3 - canceladosUltimos3) / totalUltimos3) * 100) : 0;
    const barUltimos3 = totalUltimos3 === 0 ? '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>' : `<div class="progress"><div class="bar ${colorClass(qualidadeUltimos3)}" style="width:${Math.max(qualidadeUltimos3, 5)}%">${qualidadeUltimos3}%</div></div>`;
    
    const ultimos3 = `<div style="font-size:12px;color:#6b7280;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #e5e7eb"><strong>√öltimos 3 Meses</strong></div><div class="kv"><span>Total:</span><strong>${totalUltimos3}</strong></div><div class="kv"><span>Retidos:</span><strong>${retidosUltimos3}</strong></div><div class="kv"><span>Cancelados:</span><strong>${canceladosUltimos3}</strong></div><div class="kv"><span>Qualidade:</span><strong>${qualidadeUltimos3}%</strong></div><div class="progress-wrap" style="margin-top:6px">${barUltimos3}</div>`;
    
    const mesAtual = `<div style="font-size:12px;color:#6b7280;margin:10px 0 8px 0;padding-top:8px;border-top:1px solid #e5e7eb"><strong>M√™s Atual</strong></div><div class="kv"><span>Total M√™s:</span><strong>${totalMes}</strong></div><div class="kv"><span>Retidos:</span><strong>${retidosMes}</strong></div><div class="kv"><span>Cancelados:</span><strong>${safeNum(c.canceladoMes)}</strong></div><div class="kv"><span>Qualidade:</span><strong>${qualidade}%</strong></div>`;
    
    let barMesAtual;
    if(totalMes === 0) {
      barMesAtual = '<div style="height:20px;background:#e5e7eb;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px">SEM DADOS</div>';
    } else {
      barMesAtual = `<div class="progress"><div class="bar ${colorClass(qualidade)}" style="width:${Math.max(qualidade, 5)}%">${qualidade}%</div></div>`;
    }
    
    return `<div class="card"><h3>${c.nome || 'Sem nome'}</h3>${ultimos3}${mesAtual}<div class="progress-wrap" style="margin-top:8px">${barMesAtual}</div></div>`;
  }
  
  const topCards = document.getElementById('topCardsRetencao');
  if(topCards) {
    const totalRetidos = safeNum(geral.totalRetidosMes);
    const totalCancelados = safeNum(geral.totalCanceladosMes);
    const taxaRetencao = (totalRetidos + totalCancelados) > 0 ? ((totalRetidos / (totalRetidos + totalCancelados)) * 100).toFixed(2) : 0;
    
    topCards.innerHTML = 
      renderBigCardRetencao('TAXA DE RETEN√á√ÉO', taxaRetencao + '%', 'Retidos / (Retidos + Cancelados)') +
      renderBigCardRetencao('CHURN FRANQUIA', safeNum(geral.churnFranquia).toFixed(2) + '%', 'Cancelados dos consultores') +
      renderBigCardRetencao('CHURN RATE', safeNum(geral.churnRate).toFixed(2) + '%', 'Total de cancelados') +
      renderBigCardRetencao('TOTAL CANCELADOS M√äS', safeNum(geral.totalCanceladosMes), 'Cancelamentos do m√™s') +
      renderBigCardRetencao('TOTAL RETIDOS M√äS', safeNum(geral.totalRetidosMes), 'Clientes retidos');
  }
  
  const sections = document.getElementById('sectionsRetencao');
  if(sections) {
    if(consultoras.length === 0) {
      sections.innerHTML = '<div class="section-title">CONSULTORAS <span style="color:#9ca3af;font-size:14px;font-weight:400">(vazio)</span></div>';
    } else {
      sections.innerHTML = `<div class="section-title">CONSULTORAS - √öLTIMOS 3 MESES + M√äS ATUAL</div><div class="cards-grid">${consultoras.map(renderConsultoraCard).join('')}</div>`;
    }
  }
}

function renderAdimplencia() {
  if(!lastDataAdimplencia?.data) return;
  
  const data = lastDataAdimplencia.data;
  const geral = data.geral || {};
  const secoes = data.secoes || {};
  
  function renderBigCardAdimplencia(title, value, subtitle) {
    return `<div class="big-card"><small>${title}</small><h2>${value}</h2><div>${subtitle}</div></div>`;
  }
  
  function renderFaixaCard(titulo, total, percent) {
    const p = safeNum(percent);
    const bar = `<div class="progress"><div class="bar green" style="width:${Math.max(p, 5)}%">${p}%</div></div>`;
    return `<div class="big-card"><small>${titulo}</small><h2>${safeNum(total)}</h2><div>${p}% do total</div>${bar}</div>`;
  }
  
  function renderColaboradorCard(c) {
    const arrecadado = safeNum(c.arrecadado);
    const tk = safeNum(c.tk);
    const qia = safeNum(c.qia);
    const trocas = safeNum(c.totalTrocas);
    
    return `<div class="card"><h3>${c.nome}</h3><div class="kv"><span>Arrecadado:</span><strong>${formatCurrency(arrecadado)}</strong></div><div class="kv"><span>QIA:</span><strong>${qia}</strong></div><div class="kv"><span>TK:</span><strong>${formatCurrency(tk)}</strong></div><div class="kv"><span>Trocas:</span><strong>${trocas}</strong></div></div>`;
  }
  
  const topCards = document.getElementById('topCardsAdimplencia');
  if(topCards) {
    topCards.innerHTML = 
      renderBigCardAdimplencia('TOTAL MC', safeNum(geral.totalMC), 'Total de movimenta√ß√µes') +
      renderBigCardAdimplencia('TOTAL ARRECADADO', formatCurrency(geral.totalArrecadado), 'Valor total arrecadado') +
      renderBigCardAdimplencia('TKM', formatCurrency(geral.tkm), 'Ticket m√©dio') +
      renderBigCardAdimplencia('TOTAL TROCAS', safeNum(geral.totalTrocas), 'Trocas realizadas') +
      renderFaixaCard('NOVOS REJEITADOS (NR)', safeNum(geral.totalNIR), safeNum(geral.percentNIR)) +
      renderFaixaCard('1 a 3 meses', safeNum(geral.total1a3), safeNum(geral.percent1a3)) +
      renderFaixaCard('4 a 6 meses', safeNum(geral.total4a6), safeNum(geral.percent4a6));
  }
  
  const sections = document.getElementById('sectionsAdimplencia');
  if(sections) {
    const nirColaboradores = secoes.nir || [];
    const um3Colaboradores = secoes.um_a_tres || [];
    const quatro6Colaboradores = secoes.quatro_a_seis || [];
    
    let html = '';
    
    if(nirColaboradores.length > 0) {
      html += `<div class="section-title">NOVOS REJEITADOS (NR)</div><div class="cards-grid">${nirColaboradores.map(renderColaboradorCard).join('')}</div>`;
    }
    
    if(um3Colaboradores.length > 0) {
      html += `<div class="section-title">1 A 3 MESES EM ABERTO</div><div class="cards-grid">${um3Colaboradores.map(renderColaboradorCard).join('')}</div>`;
    }
    
    if(quatro6Colaboradores.length > 0) {
      html += `<div class="section-title">4 A 6 MESES EM ABERTO</div><div class="cards-grid">${quatro6Colaboradores.map(renderColaboradorCard).join('')}</div>`;
    }
    
    sections.innerHTML = html;
  }
}

function renderCashback() {
  if(!lastDataCashback?.data) return;
  
  const data = lastDataCashback.data;
  const geral = data.geral || {};
  const metricas = data.metricas || {};
  const parceiros = data.parceiros || [];
  const colaboradores = data.colaboradores || [];
  const colabMetricas = data.colaboradoresMetricas || {};
  
  function renderBigCard(title, value, subtitle, customClass = '') {
    return `<div class="big-card ${customClass}"><small>${title}</small><h2>${value}</h2><div>${subtitle}</div></div>`;
  }
  
  function renderBigCardWithBar(title, total, ok, customClass = '') {
    const percent = pct(ok, total);
    const bar = total === 0 ? '' : `<div class="progress-wrap" style="margin-top:10px"><div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div></div>`;
    return `<div class="big-card ${customClass}"><small>${title}</small><h2>${safeNum(ok)}</h2><div>${percent}% de ${safeNum(total)}</div>${bar}</div>`;
  }
  
  function renderParceiro(p) {
    if(p.nome === 'PARCEIROS') return '';
    const valor = safeNum(p.valorCashback);
    return `<div class="cashback-card"><h3>${p.nome}</h3><div class="kv"><span>Segmento:</span><strong>${p.segmento || '-'}</strong></div><div class="kv"><span>Cashback:</span><strong>${formatCurrency(valor)}</strong></div><div class="kv"><span>Tend√™ncia:</span><strong>${formatCurrency(safeNum(p.tendencia))}</strong></div></div>`;
  }
  
  function getCorCashback(valor) {
    const v = safeNum(valor);
    if(v === 0) return '#ef4444'; // Vermelho
    if(v > 0 && v < 3) return '#f97316'; // Laranja Mais Escuro para a faixa entre 0 e 3
    return '#22c55e'; // Verde
  }
  
  function renderColaborador(c) {
    const cor = getCorCashback(c.cashbackMes);
    const almocoStatus = c.ganhouAlmoco ? '‚úì Ganhou' : '-';
    return `<div class="cashback-card" style="border-left: 4px solid ${cor}"><h3>${c.nome}</h3><div class="kv"><span>Cashback:</span><strong style="color:${cor}">${c.cashbackTexto}</strong></div><div class="kv"><span>Almo√ßo:</span><strong>${almocoStatus}</strong></div></div>`;
  }
  
  const parceirosValidos = parceiros.filter(p => p.nome !== 'PARCEIROS');
  const qtdParceiros = parceirosValidos.length;
  const qtdParceirosAcima20 = parceirosValidos.filter(p => safeNum(p.valorCashback) >= 20).length;
  
  // C√°lculo da nova m√©trica: Entre R$ 0,00 e < R$ 3,00
  const totalEntre0e3 = safeNum(colabMetricas.totalColaboradores) - safeNum(colabMetricas.totalAcima3) - safeNum(colabMetricas.totalZerados);
  const percentEntre0e3 = safeNum(colabMetricas.totalColaboradores) > 0 ? ((totalEntre0e3 / safeNum(colabMetricas.totalColaboradores)) * 100).toFixed(2) : 0;


  const topCards = document.getElementById('topCardsCashback');
  if(topCards) {
    // Reorganiza√ß√£o
    topCards.innerHTML = 
      renderBigCard('TOTAL CASHBACK', formatCurrency(geral.totalCashback), 'Valor total gerado') +
      renderBigCard('QTD. PARCEIROS', qtdParceiros, 'Total de parceiros') +
      // Novo card com barra de progresso
      renderBigCardWithBar('QTD. >= R$ 20', qtdParceiros, qtdParceirosAcima20, '') +
      renderBigCard('META DI√ÅRIA', formatCurrency(metricas.metaDiariaCashback), 'Meta di√°ria') +
      renderBigCard('TEND√äNCIA', formatCurrency(metricas.tendenciaRealizado), 'Tend√™ncia realizado');
  }
  
  const sections = document.getElementById('sectionsCashback');
  if(sections) {
    
    // Cards de Colaboradores
    let html = '<div class="section-title">M√âTRICAS DE COLABORADORES</div><div class="top-cards">';
    html += renderBigCard('TOTAL COLAB.', safeNum(colabMetricas.totalColaboradores), 'Total de colaboradores', 'total-colab') +
            renderBigCard('ACIMA DE R$ 3', safeNum(colabMetricas.totalAcima3), safeNum(colabMetricas.percentAcima3) + '%', 'acima-3') +
            // Novo Card
            renderBigCard('ENTRE R$ 0 E < R$ 3', totalEntre0e3, percentEntre0e3 + '%', 'entre-0-3') +
            renderBigCard('ZERADOS', safeNum(colabMetricas.totalZerados), safeNum(colabMetricas.percentZerados) + '%', 'zerados');
    html += '</div>';
    
    if(parceirosValidos.length > 0) {
      html += `<div class="section-title">PARCEIROS</div><div class="cashback-grid">${parceirosValidos.map(renderParceiro).join('')}</div>`;
    }
    
    if(colaboradores.length > 0) {
      html += `<div class="section-title">COLABORADORES</div><div class="cashback-grid">${colaboradores.map(renderColaborador).join('')}</div>`;
    }
    
    sections.innerHTML = html;
  }
}

function renderDashboard() {
  const content = document.getElementById('dashboardContent');
  let html = '<div class="dashboard-grid">';
  
  if(lastDataContagemApp?.data?.geral) {
    const gv = lastDataContagemApp.data.geral.vendas || {total: 0, ok: 0, sem: 0};
    const percent = pct(gv.ok, gv.total);
    const bar = gv.total === 0 ? '' : `<div class="progress-wrap"><div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div></div>`;
    html += `<div class="dashboard-section"><h3>üì± Contagem APP - Vendas</h3><div class="card"><div class="kv"><span>Total:</span><strong>${safeNum(gv.total)}</strong></div><div class="kv"><span>Sem APP:</span><strong>${safeNum(gv.sem)}</strong></div><div class="kv"><span>APP OK:</span><strong>${safeNum(gv.ok)}</strong></div>${bar}</div></div>`;
  }
  
  if(lastDataVendas?.data?.geral) {
    const gtv = lastDataVendas.data.geral.vendasTotais || {total: 0, ok: 0, pendencia: 0};
    const percent = pct(gtv.ok, gtv.total);
    const bar = gtv.total === 0 ? '' : `<div class="progress-wrap"><div class="progress"><div class="bar ${colorClass(percent)}" style="width:${Math.max(percent, 5)}%">${percent}%</div></div></div>`;
    html += `<div class="dashboard-section"><h3>üí∞ Vendas Totais</h3><div class="card"><div class="kv"><span>Total:</span><strong>${safeNum(gtv.total)}</strong></div><div class="kv"><span>Pend√™ncias:</span><strong>${safeNum(gtv.pendencia)}</strong></div><div class="kv"><span>OK:</span><strong>${safeNum(gtv.ok)}</strong></div>${bar}</div></div>`;
  }
  
  if(lastDataRefuturiza?.data?.geral) {
    const ref = lastDataRefuturiza.data.geral;
    html += `<div class="dashboard-section"><h3>üîÑ Refuturiza</h3><div class="card"><div class="kv"><span>Total:</span><strong>${safeNum(ref.totalRefuturiza)}</strong></div><div class="kv"><span>Com Liga√ß√£o:</span><strong>${safeNum(ref.comLigacao)}</strong></div></div></div>`;
  }
  
  if(lastDataRetencao?.data?.geral) {
    const ret = lastDataRetencao.data.geral;
    // Altera√ß√£o solicitada: Churn Franquia e Retidos
    html += `<div class="dashboard-section"><h3>üîê Reten√ß√£o</h3><div class="card"><div class="kv"><span>Churn Franquia:</span><strong>${safeNum(ret.churnFranquia).toFixed(2)}%</strong></div><div class="kv"><span>Retidos:</span><strong>${safeNum(ret.totalRetidosMes)}</strong></div></div></div>`;
  }
  
  if(lastDataAdimplencia?.data?.geral) {
    const adim = lastDataAdimplencia.data.geral;
    // Formato de moeda atualizado
    html += `<div class="dashboard-section"><h3>‚úÖ Adimpl√™ncia</h3><div class="card"><div class="kv"><span>Arrecadado:</span><strong>${formatCurrency(adim.totalArrecadado)}</strong></div><div class="kv"><span>TKM:</span><strong>${formatCurrency(adim.tkm)}</strong></div></div></div>`;
  }
  
  if(lastDataCashback?.data?.geral) {
    const cash = lastDataCashback.data.geral;
    // Formato de moeda atualizado
    html += `<div class="dashboard-section"><h3>üéÅ Cashback</h3><div class="card"><div class="kv"><span>Total:</span><strong>${formatCurrency(cash.totalCashback)}</strong></div><div class="kv"><span>Dias Restantes:</span><strong>${safeNum(cash.diasRestantes)}</strong></div></div></div>`;
  }
  
  html += '</div>';
  content.innerHTML = html;
}

// --- C√ìDIGO DE CORRE√á√ÉO DE POSICIONAMENTO FIXO (SEM ALTERA√á√ÉO) ---

function adjustFixedElements() {
  const header = document.querySelector('header');
  const tabsContainer = document.querySelector('.tabs-container');
  const body = document.querySelector('body');

  // 1. Altura do Header
  const headerHeight = header.offsetHeight;
  
  // 2. Reposiciona o Tabs Container, logo abaixo do header
  tabsContainer.style.top = `${headerHeight}px`;

  // 3. Altura TOTAL DOS ELEMENTOS FIXOS
  const fixedHeight = headerHeight + tabsContainer.offsetHeight;

  // 4. Ajusta o padding-top do Body
  body.style.paddingTop = `${fixedHeight + 18}px`; // Adicionado +18px para o padding original do .wrap
}

// Inicializa√ß√£o
if(document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    init();
    setupButtons(); 
    adjustFixedElements();
  });
} else {
  init();
  setupButtons();
  adjustFixedElements();
}

// Recalcula o posicionamento ao redimensionar
window.addEventListener('resize', adjustFixedElements);

// Otimiza√ß√£o: A atualiza√ß√£o autom√°tica a cada 3 minutos agora S√ì recarrega
// os dados da Dashboard e for√ßa a atualiza√ß√£o da aba ativa (se n√£o for a Dashboard).
setInterval(init, 180000);
</script>
</body>
</html>
